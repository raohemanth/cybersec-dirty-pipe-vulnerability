/*
 * inotify_monitor.c
 *
 * This program monitors the /etc directory for file modification events
 * using the inotify API. If a file modification event is detected,
 * it prints a message indicating a potential dirty pipe exploit.
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/inotify.h>

#define EVENT_SIZE  ( sizeof (struct inotify_event) )
#define EVENT_BUF_LEN     ( 1024 * ( EVENT_SIZE + 16 ) )

/**
 * @brief Main function to set up inotify, monitor /etc directory, and detect file modifications.
 *
 * @param argc Number of command-line arguments.
 * @param argv Array of command-line arguments.
 * @return Returns 0 on successful execution.
 */
int main(int argc, char **argv) {

  // Initialize inotify file descriptor and buffer
  int inotifyFd, wd;
  char buffer[EVENT_BUF_LEN];

  // Create an inotify instance
  inotifyFd = inotify_init();

  // Check for initialization errors
  if (inotifyFd < 0) {
    perror("inotify_init");
  }

  // Add a watch for file modification events in the /etc directory
  wd = inotify_add_watch(inotifyFd, "/etc", IN_MODIFY);

  // Monitor for file modification events indefinitely
  while(1) {

    // Read events from the inotify file descriptor
    int length = read(inotifyFd, buffer, EVENT_BUF_LEN);

    // Check for read errors
    if (length < 0) {
      perror("read");
    }

    // Process each event in the buffer
    int i = 0;
    while (i < length) {
      struct inotify_event *event = (struct inotify_event *) &buffer[i];
      if (event->len) {
        // Check for file modification event
        if (event->mask & IN_MODIFY) {
          // Print a message indicating a potential dirty pipe exploit
          printf("Dirty pipe exploit detected!\n");
          // Note: Uncommenting the following line would terminate the program on exploit detection
          // exit(1);
        }
      }
      // Move to the next event in the buffer
      i += EVENT_SIZE + event->len;
    }
  }

  // Remove the watch and close the inotify file descriptor
  inotify_rm_watch(inotifyFd, wd);
  close(inotifyFd);

  // Exit the program with a success status
  return 0;
}
