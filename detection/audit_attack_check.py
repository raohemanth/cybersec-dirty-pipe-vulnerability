import subprocess
import re
import time
# Define the command to get the audit logs
audit_command = ["ausearch", "-k", "dirty_pipe_detection", "--raw"]

def check_dirty_pipe():
    try:
        # Run the audit command to get logs
        audit_output = subprocess.check_output(audit_command).decode('utf-8')
        
        # Regular expression to find suspicious activity
        # This is a simplistic pattern and would need to be more sophisticated
        # for a real-world scenario.
        pattern = re.compile(r"something suspicious")

        # Search for the pattern
        if pattern.search(audit_output):
            print("Potential Dirty Pipe exploitation detected.")
            # Add further steps to handle the detection, like alerting an admin or shutting down a service
    except subprocess.CalledProcessError as e:
        print("Error while checking for Dirty Pipe exploit:", e.output)

# Run the check periodically
while True:
    check_dirty_pipe()
    # Sleep for a specified amount of time before rechecking
    time.sleep(60)