/*
 * seccomp_example.c
 *
 * This C program demonstrates the use of seccomp to restrict the system calls that
 * a process is allowed to make. In this example, the 'splice' syscall is blocked.
 */

#include <stdio.h>
#include <unistd.h>
#include <seccomp.h>
#include <linux/filter.h>
#include <linux/seccomp.h>
#include <errno.h>

int main() {

    // Initialize seccomp
    printf("Initializing seccomp...\n");
    scmp_filter_ctx ctx = seccomp_init(SCMP_ACT_ALLOW); // Default action is to allow

    // Check if seccomp initialization is successful
    if (ctx == NULL) {
        printf("Failed to initialize seccomp\n");
        return -1;
    }

    // Add a rule to block the 'splice' syscall
    printf("Adding rule to block 'splice' syscall...\n");
    int result = seccomp_rule_add(ctx, SCMP_ACT_ERRNO(EPERM), SCMP_SYS(splice), 0);

    // Check if adding the rule is successful
    if (result < 0) {
        printf("Failed to add rule to block 'splice'\n");
        seccomp_release(ctx);
        return -1;
    }

    // Load the seccomp filter
    printf("Loading seccomp filter...\n");
    result = seccomp_load(ctx);

    // Check if loading the seccomp filter is successful
    if (result < 0) {
        printf("Failed to load seccomp filter\n");
        seccomp_release(ctx);
        return -1;
    }

    // Indicate successful loading of the seccomp filter
    printf("Seccomp filter loaded successfully. Continuing with the rest of the program...\n");

    // Release seccomp resources
    printf("Releasing seccomp resources...\n");
    seccomp_release(ctx);

    // Indicate the release of seccomp resources and exit the program
    printf("Seccomp resources released. Exiting program.\n");

    return 0;
}
