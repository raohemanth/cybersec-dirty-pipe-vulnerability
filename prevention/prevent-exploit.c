/**
 * seccomp_filter.c
 * 
 * Seccomp program to add filter rules allowing only specific
 * splice syscalls - stdin fd to pipe and pipe to stdout fd. 
 * This prevents dirty pipe exploit by not allowing pipe to 
 * pipe splice directly.
*/

#include <stdio.h>
#include <unistd.h>
#include <seccomp.h>
#include <linux/filter.h>
#include <linux/seccomp.h>
#include <errno.h>

// Splice flags
#define SPLICE_F_NONBLOCK 2
#define SPLICE_F_MORE 4
#define SPLICE_F_GIFT 8

/**
 * Initialize seccomp filter, add splice rules, 
 * load filter and release resources
*/
int main() {

    // Initialize seccomp filter
    printf("Initializing seccomp...\n");
    
    scmp_filter_ctx ctx = seccomp_init(SCMP_ACT_ALLOW);
    
    if (ctx == NULL) {
        printf("Failed to initialize seccomp\n");
        return -1;
    }

    // Allow splice from fd (stdin) to pipe
    printf("Adding rule to allow splice from fd to pipe...\n");   
    int result = seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(splice), 1,
             SCMP_A0(SCMP_CMP_EQ, STDIN_FILENO),  
             SCMP_A1(SCMP_CMP_MASKED_EQ, SPLICE_F_MOVE, SPLICE_F_MOVE));

   if (result < 0) {
       printf("Failed to add rule to allow splice\n");
       seccomp_release(ctx);
       return -1;
   }

   // Allow splice from pipe to fd (stdout)
   printf("Adding rule to allow splice from pipe to fd...\n");
    
   result = seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(splice), 1,
            SCMP_A0(SCMP_CMP_MASKED_EQ, SPLICE_F_MOVE, SPLICE_F_MOVE), 
            SCMP_A1(SCMP_CMP_EQ, STDOUT_FILENO));
            
   if (result < 0) {
       printf("Failed to add rule to allow splice\n");
       seccomp_release(ctx);
       return -1;
   }

   // Load filter  
   printf("Loading seccomp filter...\n");
    
   result = seccomp_load(ctx);

   if (result < 0) {
       printf("Failed to load seccomp filter\n");
       seccomp_release(ctx);
       return -1;
   }
   
   printf("Seccomp filter loaded successfully\n");
    
   // Release resources   
   seccomp_release(ctx);

   printf("Releasing seccomp resources...\n");
   printf("Seccomp resources released. Exiting program.\n");

   return 0;
}
